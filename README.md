# 名票作成アプリ、メンテナンス・操作マニュアル

このドキュメントは、書道作品展などで使用する「名票」をPDFで自動作成するツール `kaisetu.py` の操作およびメンテナンス方法について解説したものです。

## 1. ツールの概要

このツールは以下の機能を持っています。
- **入力**: 作品情報や学生情報が記載されたCSVファイル（[専用のgoogleform](https://docs.google.com/forms/d/e/1FAIpQLSer42Z8IgWmUUb3lMVbyy3X5TPv1y3zhMlVxdA0-otEtIC8Kg/viewform?usp=sharing&ouid=108456637930435337787)の集計結果をcsvファイルとして出力したもの）
- **処理**:
    - データの読み込み（UTF-8およびShift-JISに対応）
    - データの自動整形（半角カナの全角化、臨書/創作による項目の自動選択など）
    - レイアウト調整（A4縦書き、特殊な禁則処理(改行間際の句読点の位置など)、擬似太字化など）
- **出力**: A4サイズのPDFファイル（1ページに2枚分の名票配置、または1人1ファイルの個別出力）

## 2. 動作環境・セットアップ

このツールを実行するには、Python環境が必要です。また、フォントの配置はWindows環境を前提としています。

### 必要なもの
- Python (3.8以降推奨)
- Windows OS (フォントパスがWindows準拠のため)

### インストール手順（初回のみ）
コマンドプロンプトまたはターミナルで以下のコマンドを実行し、必要なライブラリをインストールしてください。

```bash
pip install pandas reportlab
```

また、`tkinter` はPython標準ライブラリとして通常インストールされていますが、もしエラーが出る場合はPythonのインストール時にtcl/tkを含めるようにしてください。

### 必要なフォント
このツールは以下のフォントファイルが `C:\Windows\Fonts\` に存在することを前提としています。
- `HGRGE.TTC` (HGRゴシックE)
- `HGRME.TTC` (HGR明朝E)
- `msmincho.ttc` (MS明朝)

これらがない場合、エラーになります。

## 3. 使い方

1. `kaisetu.py` を実行します。
   ```bash
   python kaisetu.py
   ```
2. ファイル選択ダイアログが表示されるので、用意した**CSVファイル**を選択します。
3. 生成モードの確認（**個別PDF**か**結合PDF**か）が表示されるので選択します。
   - **はい (Yes)**: `nameplate` フォルダが作成され、その中に人数分のPDFが生成されます。
   - **いいえ (No)**: 全てのデータをまとめた1つのPDFファイルを保存します（保存先を指定します）。
4. 処理が完了するとメッセージが表示されます。

## 4. 入力データの仕様 (CSVファイル)

CSVファイルには以下の列が必要です（順不同可）。

| 列名 | 必須 | 説明 |
| :--- | :---: | :--- |
| **氏名** | 〇 | 制作者の名前 |
| **ふりがな** | 〇 | 氏名のふりがな |
| **学部** | △ | 「法学部」など（学年と結合されます） |
| **学年** | △ | 「3年」など（学部と結合されます） |
| **作品形式** | 〇 | 「臨」またはそれ以外（創作）。これで参照する列が変わります。 |
| **作品名（臨書）** | △ | 臨書の場合の作品名 |
| **釈文（臨書）** | △ | 臨書の場合の釈文 |
| **コメント（臨書）** | △ | 臨書の場合のコメント |
| **作品名（創作）** | △ | 創作の場合の作品名 |
| **釈文（創作）** | △ | 創作の場合の釈文 |
| **コメント（創作）** | △ | 創作の場合のコメント |
| **創作の種類** | △ | 創作の場合のサブタイトル（例：「自由作品」など） |
| **作者名** | △ | 臨書の元となった作者名（例：「王羲之」）。「無し」とすると表示されません。 |
| **再提出** | - | 「再提出」と入力されていると、PDFの下部に「再提出」と表示されます。 |

> [!IMPORTANT]
> 各列の題名（ヘッダー）が上記の表と完全に一致していないと、ツールは正しく動作しません。CSVファイルを作成する際は、列名に誤字脱字や余計なスペースが含まれていないか十分に確認してください。

## 5. メンテナンス・修正方法

コード内の定数部分を書き換えることで、大まかな調整が可能です。

### 文字の太さを変えたい場合
コード冒頭の `BOLD_WIDTH_RATIO` を変更してください。数字を大きくすると太く、小さくすると細くなります。
```python
# 例: 少し細くする
BOLD_WIDTH_RATIO = 0.02
```

### 特定の文字が表示されない・フォントを変えたい場合
`SPECIAL_CHARS_FONT_MAP` に追加してください。
```python
SPECIAL_CHARS_FONT_MAP = {
    '嵗': 'MSMincho', # 嵗はMS明朝で表示
    # 追加
    '𠮷': 'MSMincho',
}
```

### 配置（レイアウト）がずれている場合
`COORDINATES` 辞書の中身を修正します。
- `x`, `y`: 表示位置（左下が原点）
- `font_size`: フォントサイズ
- `adjustments`: 文字ごとの微調整設定

例えば、「名前」の位置を右に動かしたい場合は、`'名前'` キーの中の `x` の数値を増やします。

```python
    '名前': {
        'handler': 'name_and_furigana',
        'x': 260, # 250 -> 260 に変更
        ...
```

### エラーが出る場合
1. **CSVの文字コード**: 基本的には自動判定しますが、うまく読み込めない場合は `UTF-8` または `Shift-JIS` で保存し直してください。
2. **フォントエラー**: エラーメッセージに表示されたフォントパスを確認してください。PCによってフォントファイル名が大文字・小文字で異なる場合があります（コード内のパスを修正してください）。

## 6. 技術的詳細・開発者向けマニュアル (Technical Manual)

以下は、コードを修正・拡張する開発者（メンテナンス担当者）向けの技術解説です。

### 6.1 コード構成 (Code Structure)

`kaisetu.py` は大きく分けて以下のセクションで構成されています。

1.  **Imports & Constants**: 必要なライブラリのインポートと、レイアウトや微調整用の定数定義 (`COORDINATES`, `ADJUSTMENTS` 等)。
2.  **Drawing Functions (`draw_...`)**: PDFキャンバス(`reportlab`)にテキストを描画する関数群。
3.  **Data Processing (`preprocess_data`)**: pandas DataFrameに対するデータクレンジングとフォーマット処理。
4.  **PDF Generation (`generate_...`)**: ページレイアウトを制御し、ファイルを出力する関数。
5.  **Main Entry (`main`)**: UI制御（ファイル選択）と処理フローの統括。

### 6.2 主要関数の機能解説

#### `preprocess_data(data: pd.DataFrame) -> pd.DataFrame`
生データのCSVを読み込んだ後、描画しやすい形に整形する重要関数です。
- **全角化**: `to_full_width` 関数を使用し、半角カタカナや英数字を全角に変換します（縦書き表示対応のため）。
- **条件分岐データの結合**: 「作品形式（臨/創作）」などのカラム値によって、参照するカラム（`釈文（臨書）` vs `釈文（創作）`）を動的に切り替えています。
- **文字列結合**: 学部と学年を繋げたり、作者名と作品名をフォーマットに従って結合する処理を行います。

#### `draw_name_and_furigana(...)`
名前とふりがなを配置する関数です。
- 以下の特徴的な処理を行っています：
    - **1文字ごとの個別の調整**:
        - 漢字のように「マス全体に書く文字」は基本的にそのままで問題ありません。
        - しかし、「っ」のような小書き文字、英数字、特殊記号などは、一律に配置すると座標（位置）がずれたり、回転が必要だったりします。
        - そのため、単純な文字列描画ではなく、1文字ずつループ処理を行い、文字ごとに座標調整や回転処理を適用しています。

#### `draw_vertical_text_with_wrap(...)`
釈文やコメントなどの長文を縦書きで描画します。
- **禁則処理（ぶら下げ）**: `LEADING_PROHIBITED_CHARS`（句読点や閉じ括弧）が行頭に来てしまう場合、前の行に「追い込む（ぶら下げる）」処理を簡易的に実装しています。
    - ロジック: `char_count` が規定文字数を超えた際に、その文字が禁則文字であれば改行せずに行末（枠外）に描画し、次の文字から改行します。
- **改行の実現（強制改行）**:
    - 文字列中に改行コード (`\n`) が含まれている場合、そこで強制的に改行処理（X座標の移動とY座標のリセット）を行います。これにより、入力データ側（Googleフォームの段落入力やExcelのセル内改行など）での意図的な改行が反映されます。

### 6.3 実装の重要テクニック

#### 擬似太字 (Pseudo-Bold) 処理
日本語フォント（特にHGRGEなど）の太字ウェイトがReportLabで標準的に使えない場合に対応するため、「塗りつぶし(Fill) + 輪郭線(Stroke)」で太字に見せる処理を行っています。

```python
# Canvasの描画モードを '2 Tr' (Fill then Stroke) に変更
canvas.setLineWidth(font_size * BOLD_WIDTH_RATIO)
canvas._code.append('2 Tr')
# 文字描画...
# 描画モードを戻す '0 Tr' (Fill only)
canvas._code.append('0 Tr')
```

#### 特殊文字のフォント代替
標準フォント（HGRGEなど）に含まれない文字（外字、旧字体など）がある場合、`SPECIAL_CHARS_FONT_MAP` を用いて、その文字だけ `MSMincho` など描画可能なフォントに切り替える処理を文字ごとの描画ループ内で実装しています。

### 6.4 座標系とレイアウト調整

ReportLabの座標系は **「左下が原点 (0, 0)」** です。
- **X軸**: 右に行くほどプラス
- **Y軸**: 上に行くほどプラス

レイアウト定義辞書 `COORDINATES` は以下の構造になっています。

```python
'項目名': {
    'x': 250,       # 基準X座標
    'y': 780,       # 基準Y座標
    'font_size': 18,
    'adjustments': ... # 文字ごとのオフセット設定辞書名
}
```

位置がずれる場合は、この `x`, `y` を修正します。文字ごとの微調整が必要な場合は、`PUNCTUATION_ADJUSTMENTS` などの辞書定義を変更してください。

#### 自動中央揃え（釈文・コメント）
「釈文」や「コメント」のように、**文字列の長さ（行数）に応じて開始位置（X座標）を変えたい**場合があります（全体の行数が増えても、ブロック全体としての見た目の中心位置を保つため）。
その場合、`x` に数値をリストで指定することで、行数に応じた座標を指定できます。

```python
    '釈文': {
        'x': [152, 162, 172], # 1行の時=152, 2行の時=162, 3行の時=172
        # ...
    }
```
コード内では、`calculate_wrap_count` 関数で行数を計算し、その行数（インデックス）に対応するX座標をリストから取得しています。これにより、行数が増えてもレイアウトの中央揃え（または任意の配置調整）が維持されるようになっています。

---

## 7. お問い合わせ
73期の郭に直接Lineするか、yoyokaku6871@gmail.comに連絡してください。